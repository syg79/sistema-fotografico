<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Fotogr√°fica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/main.css" rel="stylesheet">
    <link href="assets/css/components.css" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-3">Carregando dados...</p>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-camera"></i> Sistema Fotogr√°fico
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html"><i class="fas fa-home"></i> Dashboard</a>
                    </li>
                    <!-- Links espec√≠ficos por role ser√£o adicionados via JavaScript -->
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="user-name">Usu√°rio</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="authManager.logout()">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Cabe√ßalho de Boas-vindas -->
        <div class="row">
            <div class="col-12">
                <div class="welcome-header text-center mb-4">
                    <h1 class="display-5 text-primary">
                        <i class="fas fa-camera-retro"></i>
                        Dashboard - Sistema Fotogr√°fico
                    </h1>
                    <p class="lead text-muted">Bem-vindo, <span id="welcome-user">Usu√°rio</span>!</p>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas Gerais -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total de Solicita√ß√µes</h6>
                                <h3 id="stat-total">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-list fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Agendamentos Hoje</h6>
                                <h3 id="stat-hoje">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Pendentes</h6>
                                <h3 id="stat-pendentes">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Realizados</h6>
                                <h3 id="stat-realizados">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- A√ß√µes R√°pidas por Role -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <h4><i class="fas fa-bolt"></i> A√ß√µes R√°pidas</h4>
            </div>
            
            <!-- Cards ser√£o adicionados dinamicamente baseado no role do usu√°rio -->
            <div id="quick-actions" class="row g-4">
                <!-- Conte√∫do ser√° inserido via JavaScript -->
            </div>
        </div>

        <!-- Tabela de Dados Recentes -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-table"></i> <span id="table-title">Dados Recentes</span></h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="filter-status">
                                    <option value="">Todos os Status</option>
                                    <option value="Agendado">Agendado</option>
                                    <option value="Confirmado">Confirmado</option>
                                    <option value="Realizado">Realizado</option>
                                    <option value="Editado">Editado</option>
                                    <option value="Entregue">Entregue</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filter-fotografo">
                                    <option value="">Todos os Fot√≥grafos</option>
                                    <!-- Op√ß√µes ser√£o carregadas via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="filter-data" placeholder="Data">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="filter-search" placeholder="Buscar...">
                            </div>
                        </div>

                        <!-- Tabela -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr id="table-headers">
                                        <!-- Headers ser√£o inseridos via JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <tr>
                                        <td colspan="100%" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            Carregando dados...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagina√ß√£o -->
                        <nav aria-label="Navega√ß√£o da tabela">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagina√ß√£o ser√° inserida via JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/app-config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/csv-loader.js"></script>
    <script src="assets/js/google-sheets-api.js"></script>
    <script src="assets/js/google-sheets-writer.js"></script>
    <script src="assets/js/loading-indicator.js"></script>
    <script src="assets/js/data-loader.js"></script>
    <script>
        // Vari√°veis globais
        let currentData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = CONFIG.UI.ITEMS_PER_PAGE;

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar autentica√ß√£o - se n√£o houver, criar sess√£o tempor√°ria
            if (!authManager.isAuthenticated) {
                console.log('üîß Criando sess√£o tempor√°ria para acesso direto...');
                // Criar usu√°rio tempor√°rio para acesso direto
                const tempUser = {
                    id: 'temp-user',
                    nome: 'Usu√°rio Tempor√°rio',
                    email: 'temp@sistema.com',
                    role: 'admin',
                    permissions: ['read', 'write', 'admin']
                };
                
                // Salvar sess√£o tempor√°ria
                authManager.saveSession(tempUser);
                authManager.isAuthenticated = true;
                authManager.currentUser = tempUser;
                authManager.userRole = 'admin';
                
                console.log('‚úÖ Sess√£o tempor√°ria criada com sucesso');
            }

            // Aguardar inicializa√ß√£o do DataLoader
            console.log('üîÑ Aguardando inicializa√ß√£o do DataLoader...');
            await dataLoader.initializeLoader();
            console.log('‚úÖ DataLoader inicializado');

            // Configurar interface baseada no role
            setupUserInterface();
            
            // Carregar dados iniciais
            await loadInitialData();
            
            // Configurar event listeners
            setupEventListeners();
            
            // Ocultar loading
            hideLoading();
        });

        function setupUserInterface() {
            const user = authManager.getCurrentUser();
            const role = authManager.getCurrentRole();
            
            // Atualizar nome do usu√°rio
            document.getElementById('user-name').textContent = user.nome;
            document.getElementById('welcome-user').textContent = user.nome;
            
            // Configurar navega√ß√£o baseada no role
            setupNavigation(role);
            
            // Configurar a√ß√µes r√°pidas
            setupQuickActions(role);
        }

        function setupNavigation(role) {
            const navMenu = document.querySelector('.navbar-nav.me-auto');
            
            // Links espec√≠ficos por role
            const roleLinks = {
                'fotografo': [
                    { href: 'fotografos/agenda.html', icon: 'calendar', text: 'Minha Agenda' }
                ],
                'editor': [
                    { href: 'editores/trabalhos.html', icon: 'edit', text: 'Trabalhos' }
                ],
                'gestor': [
                    { href: 'conferencia/dashboard.html', icon: 'chart-bar', text: 'Relat√≥rios' }
                ],
                'admin': [
                    { href: 'conferencia/dashboard.html', icon: 'chart-bar', text: 'Relat√≥rios' },
                    { href: '#', icon: 'cog', text: 'Configura√ß√µes' }
                ]
            };

            const links = roleLinks[role] || [];
            links.forEach(link => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.innerHTML = `<a class="nav-link" href="${link.href}">
                    <i class="fas fa-${link.icon}"></i> ${link.text}
                </a>`;
                navMenu.appendChild(li);
            });
        }

        function setupQuickActions(role) {
            const container = document.getElementById('quick-actions');
            
            const actions = {
                'fotografo': [
                    { 
                        title: 'Minha Agenda', 
                        desc: 'Ver agendamentos de hoje', 
                        icon: 'calendar-day', 
                        color: 'primary',
                        href: 'fotografos/agenda.html'
                    }
                ],
                'editor': [
                    { 
                        title: 'Trabalhos Pendentes', 
                        desc: 'Ver trabalhos para editar', 
                        icon: 'edit', 
                        color: 'warning',
                        href: 'editores/trabalhos.html'
                    }
                ],
                'gestor': [
                    { 
                        title: 'Dashboard Completo', 
                        desc: 'Ver relat√≥rios detalhados', 
                        icon: 'chart-bar', 
                        color: 'info',
                        href: 'conferencia/dashboard.html'
                    }
                ],
                'admin': [
                    { 
                        title: 'Dashboard Completo', 
                        desc: 'Ver relat√≥rios detalhados', 
                        icon: 'chart-bar', 
                        color: 'info',
                        href: 'conferencia/dashboard.html'
                    },
                    { 
                        title: 'Configura√ß√µes', 
                        desc: 'Gerenciar sistema', 
                        icon: 'cog', 
                        color: 'secondary',
                        href: '#'
                    }
                ]
            };

            const userActions = actions[role] || [];
            userActions.forEach(action => {
                const div = document.createElement('div');
                div.className = 'col-md-6 col-lg-4';
                div.innerHTML = `
                    <div class="card h-100 shadow-sm hover-card">
                        <div class="card-body text-center">
                            <div class="feature-icon bg-${action.color} text-white rounded-circle mx-auto mb-3">
                                <i class="fas fa-${action.icon} fa-2x"></i>
                            </div>
                            <h5 class="card-title">${action.title}</h5>
                            <p class="card-text">${action.desc}</p>
                            <a href="${action.href}" class="btn btn-${action.color}">Acessar</a>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function loadInitialData(options = {}) {
            const { showOverlay = true } = options;
            try {
                if (showOverlay) {
                    showLoading();
                }
                
                // Carregar dados baseado no role
                const role = authManager.getCurrentRole();
                const roleKey = role ? role.toUpperCase() : '';
                let filters = CONFIG.DEFAULT_FILTERS[roleKey] || {};
                
                // Para arquivos grandes, carregar apenas a primeira p√°gina inicialmente
                const optionsLoader = {
                    pageSize: 100,
                    loadAll: false,
                    startRow: 0
                };
                
                console.log('[INFO] Carregando dados iniciais (primeira p√°gina - mais recentes primeiro)...');
                currentData = await dataLoader.loadSolicitacoesPaginated(filters, optionsLoader);
                filteredData = [...currentData];
                
                // Verificar se os dados foram ordenados cronologicamente
                if (currentData._pagination && currentData._pagination.isChronological) {
                    console.log('[INFO] Dados carregados em ordem cronol√≥gica (mais recentes primeiro)');
                    
                    // Mostrar informa√ß√£o sobre ordena√ß√£o na interface
                    const statusElement = document.querySelector('.loading-status');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div style="color: #28a745; font-weight: bold;">
                                Carregados os ${currentData.length} registros mais recentes
                                ${currentData._pagination.hasMore ? `(${currentData._pagination.totalRecords - currentData.length} registros mais antigos dispon√≠veis)` : ''}
                            </div>
                        `;
                    }
                }
                
                // Atualizar estat√≠sticas (estimativa baseada na primeira p√°gina)
                updateStatistics(currentData);
                
                // Carregar fot√≥grafos para filtro
                await loadFotografosFilter();
                
                // Renderizar tabela
                renderTable();
                
                // Mostrar bot√£o para carregar mais dados se necess√°rio
                showLoadMoreButton();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                const detail = error && error.message ? ` Detalhe: ${error.message}` : '';
                showError(`Erro ao carregar dados. Verifique sua conex√£o.${detail}`);
            } finally {
                if (showOverlay) {
                    hideLoading();
                }
            }
        }
        function updateStatistics(data) {
            const stats = dataLoader.calculateStatistics(data);
            const totalElement = document.getElementById('stat-total');
            if (data._pagination && data._pagination.hasMore) {
                totalElement.textContent = `${stats.total}+ (${data._pagination.totalRecords} total)`;
                totalElement.title = `Mostrando ${stats.total} registros mais recentes de ${data._pagination.totalRecords} total`;
            } else {
                totalElement.textContent = stats.total;
            }
            document.getElementById('stat-hoje').textContent = stats.today;
            document.getElementById('stat-pendentes').textContent = stats.byStatus['Agendado'] || 0;
            document.getElementById('stat-realizados').textContent = stats.byStatus['Realizado'] || 0;
        }

        async function loadFotografosFilter() {
            try {
                const fotografos = await dataLoader.loadFotografos();
                const select = document.getElementById('filter-fotografo');
                fotografos.forEach(foto => {
                    const option = document.createElement('option');
                    option.value = foto.Nome || foto.nome;
                    option.textContent = foto.Nome || foto.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.warn('Erro ao carregar fot√≥grafos:', error);
            }
        }
        function renderTable() {
            const role = authManager.getCurrentRole();
            const columns = getColumnsForRole(role);
            const headerRow = document.getElementById('table-headers');
            headerRow.innerHTML = columns.map(col => `<th>${col.title}</th>`).join('');
            renderTableData(columns, role);
            renderPagination();
        }
        
        function getColumnsForRole(role) {
            const baseColumns = [
                { key: 'Record ID', title: 'ID' },
                { key: 'Data do agendamento', title: 'Data' },
                { key: 'Status', title: 'Status' },
                { key: 'Endereco do Imovel', title: 'Endere√ßo' },
                { key: 'Nome Cliente', title: 'Cliente' }
            ];
            const actionsColumn = { key: '__actions', title: 'A√ß√µes' };
            if (!role) {
                return [
                    ...baseColumns,
                    { key: 'Fotografo', title: 'Fot√≥grafo' },
                    { key: 'Editado', title: 'Editado' }
                ];
            }
        
            switch (role) {
                case 'fotografo':
                    return [
                        ...baseColumns,
                        { key: 'Horario da Sessao', title: 'Hor√°rio' },
                        { key: 'Referencia do Cliente', title: 'Contato' },
                        actionsColumn
                    ];
                case 'editor':
                    return [
                        ...baseColumns,
                        { key: 'Fotografo', title: 'Fot√≥grafo' },
                        { key: 'Editado', title: 'Editado' },
                        actionsColumn
                    ];
                case 'gestor':
                case 'admin':
                default:
                    return [
                        ...baseColumns,
                        { key: 'Fotografo', title: 'Fot√≥grafo' },
                        { key: 'Editado', title: 'Editado' },
                        actionsColumn
                    ];
            }
        }
        
        function renderTableData(columns, role) {
            const tbody = document.getElementById('table-body');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${columns.length}" class="text-center text-muted">
                            Nenhum registro encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pageData.map(item => {
                const cells = columns.map(col => {
                    if (col.key === '__actions') {
                        return `<td>${renderActions(role, item)}</td>`;
                    }
                    let value = item[col.key] || '';
                    if (col.key === 'Status') {
                        const color = CONFIG.UI.STATUS_COLORS[value] || '#6c757d';
                        value = `<span class="badge" style="background-color: ${color}">${value}</span>`;
                    }
                    return `<td>${value}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }
        
        function renderActions(role, item) {
            const recordId = item["Record ID"];
            if (!recordId) {
                return '<span class="text-muted">‚Äî</span>';
            }
            const status = (item["Status"] || "").toString().toLowerCase();
            const editado = (item["Editado"] || "").toString().toLowerCase();
            const buttons = [];
            const encodedId = encodeURIComponent(recordId);

            const addButton = (label, action, style = "outline-primary", icon = "fa-check") => {
                buttons.push(`
                    <button type="button" class="btn btn-${style} btn-sm me-1"
                        onclick="handleSolicitacaoAction('${action}','${encodedId}')">
                        <i class="fas ${icon} me-1"></i>${label}
                    </button>
                `);
            };

            if (role === "fotografo") {
                if (["publicado", "agendado", "confirmado"].includes(status)) {
                    addButton("Confirmar Realizado", "realizado", "outline-success", "fa-camera");
                }
            } else if (role === "editor") {
                if (status === "realizado" && editado !== "sim") {
                    addButton("Marcar Editado", "editado", "outline-info", "fa-edit");
                }
            } else if (role) {
                if (!["publicado", "realizado", "editado"].includes(status)) {
                    addButton("Publicar", "publicado", "outline-primary", "fa-bullhorn");
                }
                if (!["realizado", "editado"].includes(status)) {
                    addButton("Marcar Realizado", "realizado", "outline-success", "fa-check-circle");
                }
                if (status === "realizado" && editado !== "sim") {
                    addButton("Marcar Editado", "editado", "outline-info", "fa-edit");
                }
            }

            return buttons.length
                ? `<div class="d-flex flex-wrap gap-1">${buttons.join("")}</div>`
                : '<span class="text-muted">‚Äî</span>';
        }

        async function handleSolicitacaoAction(action, encodedRecordId) {
            const recordId = decodeURIComponent(encodedRecordId || "");
            if (!recordId) {
                showError("Registro inv√°lido: ID n√£o encontrado.");
                return;
            }
            let successMessage = "Solicita√ß√£o atualizada com sucesso.";
            try {
                showLoading();
                switch (action) {
                    case "publicado":
                        await googleSheetsWriter.marcarPublicado(recordId);
                        successMessage = "Solicita√ß√£o publicada para agenda.";
                        break;
                    case "realizado":
                        await googleSheetsWriter.gerarCodigoVitrine(recordId);
                        successMessage = "Status marcado como Realizado e c√≥digo vitrine gerado.";
                        break;
                    case "editado":
                        await googleSheetsWriter.marcarEditado(recordId);
                        successMessage = "Solicita√ß√£o marcada como Editada.";
                        break;
                    default:
                        console.warn("A√ß√£o desconhecida:", action);
                        hideLoading();
                        return;
                }
                await loadInitialData({ showOverlay: false });
                alert(successMessage);
            } catch (error) {
                console.error("Erro ao atualizar solicita√ß√£o:", error);
                showError("Erro ao atualizar solicita√ß√£o. Verifique o console para detalhes.");
            } finally {
                hideLoading();
            }
        }
        

        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Bot√£o anterior
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>
                </li>
            `;
            
            // N√∫meros das p√°ginas
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Bot√£o pr√≥ximo
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Pr√≥ximo</a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTable();
        }

        function setupEventListeners() {
            // Filtros
            document.getElementById('filter-status').addEventListener('change', applyFilters);
            document.getElementById('filter-fotografo').addEventListener('change', applyFilters);
            document.getElementById('filter-data').addEventListener('change', applyFilters);
            document.getElementById('filter-search').addEventListener('input', applyFilters);
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filter-status').value;
            const fotografoFilter = document.getElementById('filter-fotografo').value;
            const dataFilter = document.getElementById('filter-data').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            
            filteredData = currentData.filter(item => {
                // Filtro por status
                if (statusFilter && item['Status'] !== statusFilter) return false;
                
                // Filtro por fot√≥grafo
                if (fotografoFilter && item['Fotografo'] !== fotografoFilter) return false;
                
                // Filtro por data
                if (dataFilter && !item['Data do agendamento']?.includes(dataFilter)) return false;
                
                // Filtro por busca
                if (searchFilter) {
                    const searchableFields = ['Endereco do Imovel', 'Nome Cliente', 'Referencia do Cliente'];
                    const matchesSearch = searchableFields.some(field => 
                        item[field]?.toLowerCase().includes(searchFilter)
                    );
                    if (!matchesSearch) return false;
                }
                
                return true;
            });
            
            currentPage = 1;
            renderTable();
        }

        async function refreshData() {
            await loadInitialData();
        }

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showLoadMoreButton() {
            // Verificar se j√° existe o bot√£o
            if (document.getElementById('load-more-btn')) return;
            
            // Verificar se h√° mais dados para carregar
            const hasMore = currentData._pagination && currentData._pagination.hasMore;
            if (!hasMore) return;
            
            const totalRecords = currentData._pagination ? currentData._pagination.totalRecords : 6556;
            const currentCount = currentData.length;
            
            // Criar bot√£o "Carregar Mais"
            const container = document.querySelector('.table-responsive');
            const button = document.createElement('div');
            button.className = 'text-center mt-3';
            button.innerHTML = `
                <button id="load-more-btn" class="btn btn-outline-primary">
                    <i class="fas fa-clock"></i> Carregar Registros Mais Antigos
                </button>
                <div class="mt-2">
                    <div class="text-success mb-1">
                        <i class="fas fa-check-circle"></i> <strong>Carregados: ${currentCount} registros mais recentes</strong>
                    </div>
                    <div class="text-muted">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            ${totalRecords - currentCount} registros mais antigos dispon√≠veis
                            <br>
                            <strong>Dica:</strong> Os dados mais relevantes (recentes) j√° est√£o carregados
                        </small>
                    </div>
                </div>
            `;
            
            container.appendChild(button);
            
            // Adicionar evento de clique
            document.getElementById('load-more-btn').addEventListener('click', loadAllData);
        }

        async function loadAllData() {
            try {
                const button = document.getElementById('load-more-btn');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando registros mais antigos...';
                button.disabled = true;
                
                // Carregar todos os dados (mantendo ordena√ß√£o cronol√≥gica)
                const role = authManager.getCurrentRole();
                let filters = CONFIG.DEFAULT_FILTERS[role.toUpperCase()] || {};
                
                const options = {
                    pageSize: 0,
                    loadAll: true,
                    startRow: 0
                };
                
                console.log('üîÑ Carregando todos os dados (mantendo ordem cronol√≥gica)...');
                currentData = await dataLoader.loadSolicitacoesPaginated(filters, options);
                filteredData = [...currentData];
                
                // Atualizar estat√≠sticas com dados completos
                updateStatistics(currentData);
                
                // Renderizar tabela com todos os dados
                renderTable();
                
                // Remover bot√£o e mostrar status
                button.parentElement.innerHTML = `
                    <div class="alert alert-success text-center">
                        <i class="fas fa-check-circle"></i> 
                        <strong>Todos os ${currentData.length} registros carregados!</strong>
                        <br>
                        <small class="text-muted">Dados ordenados cronologicamente (mais recentes primeiro)</small>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao carregar todos os dados:', error);
                
                const button = document.getElementById('load-more-btn');
                if (button) {
                    button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro - Tentar Novamente';
                    button.disabled = false;
                    button.className = 'btn btn-outline-danger';
                }
                
                showError('Erro ao carregar dados completos. Tente novamente.');
            }
        }

        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>
